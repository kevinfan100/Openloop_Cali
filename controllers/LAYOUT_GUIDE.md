# Flux Controller 佈局指南

基於 `Flux_Controller_Type3.slx` 的手動調整佈局

---

## 📐 整體佈局視圖

```
Layer 1    Layer 2    Layer 3         Layer 4    Layer 5        Layer 6              Layer 7        Layer 8
X=105      X=290      X=450-600       X=565      X=720-810      X=685-945            X=1000-1120    X=1185
  ↓          ↓           ↓              ↓           ↓               ↓                    ↓            ↓
輸入       誤差計算   延遲&創新項    估測器增益  狀態更新      前饋&反饋計算          控制律         輸出
```

---

## 🎯 詳細座標佈局

### **垂直分區（Y 座標）**

```
Y = 85-225     ┌────────────────────────────────────────┐
               │   前饋區域                              │
               │   • Vd_Delay, Vd_Delay2                │
               │   • Gain_a1, Gain_a2                   │
               │   • FF_Sum                             │
               └────────────────────────────────────────┘

Y = 137-168    ┌────────────────────────────────────────┐
               │   誤差計算                              │
               │   • Error_Calc                         │
               └────────────────────────────────────────┘

Y = 322-555    ┌────────────────────────────────────────┐
               │   估測器核心區域                        │
               │   • Innovation                         │
               │   • Gain_l1, Gain_lambda_c, Gain_l2, Gain_l3│
               │   • S1_Sum, S1_Delay  (Y=350)          │
               │   • S2_Sum, S2_Delay  (Y=450)          │
               │   • WT_Sum, WT_Delay  (Y=535)          │
               └────────────────────────────────────────┘

Y = 405-435    ┌────────────────────────────────────────┐
               │   控制律中心                            │
               │   • Control_Sum, B_inv_Gain, u         │
               └────────────────────────────────────────┘

Y = 570-640    ┌────────────────────────────────────────┐
               │   反饋區域                              │
               │   • FB_Gain1, FB_Gain2                 │
               │   • FB_Sum                             │
               └────────────────────────────────────────┘
```

---

## 🔄 信號流圖（實際座標）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                                                                 │
│  [Vd]          [Vd_Delay]────[Vd_Delay2]         [Gain_a1]                     │
│  X=105         X=450          X=550               X=820                         │
│  Y=100         Y=100          Y=100     ┌──────→  Y=210  ──┐                   │
│                                          │                   ↓                   │
│                                          │              [FF_Sum]                 │
│  [Vm]                                    │               X=915                  │
│  X=105                                   │               Y=210                  │
│  Y=160                                   │                  │                   │
│    ↓                                     │                  ↓                   │
│    │                                     │         [Control_Sum]──[B_inv]─→[u]  │
│    ├─────→ [Error_Calc] ─────────────────┤          X=1000      X=1090   X=1185│
│    │        X=290                         │          Y=420       Y=420    Y=420 │
│    │        Y=152                         │             ↑                        │
│    │          ↓                           │             │                        │
│    │          │                           │          [FB_Sum]                    │
│    │          └──→ [Innovation] ─────┬────┤           X=915                     │
│    │               X=470             │    │           Y=592                     │
│    │               Y=337             │    │              ↑                       │
│    │                                 ↓    │        [FB_Gain1] [FB_Gain2]        │
│    │                            [Gain_l1] │         X=685      X=855            │
│    │                             X=565    │         Y=585      Y=625            │
│    │                             Y=340    │            ↑          ↑              │
│    │                                ↓     │            │          │              │
│    │                           [S1_Sum]───┴──→ [S1_Delay]         │              │
│    │                            X=720         X=780    │          │              │
│    │                            Y=347         Y=350    │          │              │
│    │                               ↓                   │          │              │
│    │                         [Gain_lambda_c]           │          │              │
│    │                             X=565      ┌──────────┘          │              │
│    │                             Y=390      │                     │              │
│    │                                        │    [S2_Delay] ──────┘              │
│    │                           [Gain_l2] ──┴──→  X=780                          │
│    │                             X=565            Y=450                          │
│    │                             Y=455               │                           │
│    │                                ↓                │                           │
│    │                           [S2_Sum] ────────────┘                            │
│    │                            X=720                                            │
│    │                            Y=447                                            │
│    │                                                                             │
│    │                           [Gain_l3]                                         │
│    │                             X=565                                           │
│    │                             Y=540                                           │
│    │                                ↓                                            │
│    │                           [WT_Sum] ────────→ [WT_Delay]                     │
│    │                            X=720              X=780                         │
│    │                            Y=532              Y=535                         │
│    │                                                                             │
│    └──────────────────────────────────────────────────────────────────→ [e]     │
│                                                                          X=1185  │
│                                                                          Y=155   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 關鍵座標表

### **輸入/輸出**
| Block | X | Y (center) | Position |
|-------|---|------------|----------|
| Vd | 105 | 100 | [105, 90, 135, 110] |
| Vm | 105 | 160 | [105, 150, 135, 170] |
| u | 1185 | 420 | [1185, 410, 1215, 430] |
| e | 1185 | 155 | [1185, 145, 1215, 165] |

### **誤差與延遲**
| Block | X | Y (center) | Position |
|-------|---|------------|----------|
| Error_Calc | 305 | 152 | [290, 137, 320, 168] |
| Vd_Delay | 465 | 100 | [450, 85, 480, 115] |
| Vd_Delay2 | 565 | 100 | [550, 85, 580, 115] |

### **估測器核心**
| Block | X | Y (center) | Position |
|-------|---|------------|----------|
| Innovation | 485 | 337 | [470, 322, 500, 353] |
| Gain_l1 | 580 | 340 | [565, 325, 595, 355] |
| Gain_lambda_c | 580 | 390 | [565, 375, 595, 405] |
| Gain_l2 | 580 | 455 | [565, 440, 595, 470] |
| Gain_l3 | 580 | 540 | [565, 525, 595, 555] |

### **估測器狀態（垂直間隔 100）**
| Block | X | Y (center) | Position | 間隔 |
|-------|---|------------|----------|------|
| S1_Sum | 735 | 347 | [720, 332, 750, 363] | - |
| S1_Delay | 795 | 350 | [780, 335, 810, 365] | - |
| S2_Sum | 735 | 447 | [720, 432, 750, 463] | +100 |
| S2_Delay | 795 | 450 | [780, 435, 810, 465] | +100 |
| WT_Sum | 735 | 532 | [720, 517, 750, 548] | +85 |
| WT_Delay | 795 | 535 | [780, 520, 810, 550] | +85 |

### **前饋計算**
| Block | X | Y (center) | Position |
|-------|---|------------|----------|
| Gain_a1 | 835 | 210 | [820, 195, 850, 225] |
| Gain_a2 | 780 | 280 | [765, 265, 795, 295] |
| FF_Sum | 930 | 210 | [915, 195, 945, 225] |

### **反饋計算**
| Block | X | Y (center) | Position |
|-------|---|------------|----------|
| FB_Gain1 | 700 | 585 | [685, 570, 715, 600] |
| FB_Gain2 | 870 | 625 | [855, 610, 885, 640] |
| FB_Sum | 930 | 592 | [915, 577, 945, 608] |

### **控制律**
| Block | X | Y (center) | Position |
|-------|---|------------|----------|
| Control_Sum | 1015 | 420 | [1000, 405, 1030, 435] |
| B_inv_Gain | 1105 | 420 | [1090, 405, 1120, 435] |

---

## 🎨 佈局設計原則（你的邏輯）

### 1. **水平分層**
- 每一層代表信號流的一個處理階段
- 從左到右：輸入 → 處理 → 輸出
- 總寬度約 1100 像素

### 2. **垂直分區**
- **上方 (Y < 300)**：前饋路徑
- **中間 (Y = 300-550)**：估測器核心
- **下方 (Y > 550)**：反饋路徑
- **中心 (Y = 400-450)**：控制律與主輸出

### 3. **功能分組**
- **估測器**: 所有估測器相關模組在 X=470-810 區域
- **前饋**: 所有前饋相關模組在 Y=85-295 區域
- **反饋**: 所有反饋相關模組在 Y=570-640 區域

### 4. **對齊規則**
- **Sum → Delay**: 水平間隔 60 像素
- **估測器狀態**: 垂直間隔 100 像素
- **增益模組**: 垂直間隔 50-85 像素

---

## 🔧 使用這個佈局

### **方法 1: 使用模板函數**
```matlab
layout = layout_template();

% 建立 block 時使用座標
add_block('simulink/Sources/In1', [model '/Vd']);
set_param([model '/Vd'], 'Position', [layout.x.input, layout.y.input_vd-10, ...
                                       layout.x.input+30, layout.y.input_vd+10]);
```

### **方法 2: 直接參考座標表**
從上面的表格直接複製 Position 值

---

## 📝 未來擴展

### **Type 2 控制器（需要添加 δŵT 狀態）**
- 在 WT_Delay 下方添加
- Y 座標: 535 + 100 = 635
- 保持相同的 X 座標邏輯

### **Type 1 控制器（需要 w1, w2 兩個狀態）**
- 替換 WT_Sum/WT_Delay
- 使用相同的 Y 區域（520-550）
- 添加 beta 參數的增益模組

---

## ✅ 佈局優點

1. ✅ **信號流清晰**：一眼看出數據如何流動
2. ✅ **易於調試**：功能分組明確
3. ✅ **可擴展**：預留空間給 Type 1, 2
4. ✅ **專業外觀**：對齊整齊，邏輯清晰

---

**記錄者**: Claude Code
**佈局設計**: Kevin
**日期**: 2025-10-11
